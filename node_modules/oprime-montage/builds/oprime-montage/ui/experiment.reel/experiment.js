var ContextualizableComponent=require("core/contextualizable-component").ContextualizableComponent,experimentalDesign=require("/assets/stimuli/tcpp_design.json"),PressComposer=require("montage/composer/press-composer").PressComposer,RangeController=require("montage/core/range-controller").RangeController,PromiseController=require("montage/core/promise-controller").PromiseController;exports.Experiment=ContextualizableComponent.specialize({_currentStimulus:{value:null},_currentTestBlock:{value:null},_currentStimulusIndex:{value:null},_currentTestBlockIndex:{value:null},constructor:{value:function(){this.super(),this.experimentalDesignSrc="/assets/stimuli/tcpp_design.json";var e=this;this.designHasBeenLoaded=require.read(this.experimentalDesignSrc).then(function(t){console.log(" Loaded in the experimental Design."+this.experimentalDesignSrc),e.experimentalDesign=JSON.parse(t),e.iconSrc=e.experimentalDesign.iconSrc,e.experimentalDesign.subexperiments&&e.experimentalDesign.subexperiments.length>0&&e.experimentalDesign.subexperiments[0]&&(e._currentTestBlockIndex=0,e._currentTestBlock=e.experimentalDesign.subexperiments[e._currentTestBlockIndex]),e._currentTestBlock&&e._currentTestBlock.trials&&e._currentTestBlock.trials.length>0&&(e._currentStimulusIndex=-1)},function(){alert("Unable to load the experiment, please report this.")}),window.contextualizer.addFiles([{path:"/assets/stimuli/locale/en/messages.json",localeCode:"en"},{path:"/assets/stimuli/locale/fr/messages.json",localeCode:"fr"},{path:"/assets/stimuli/locale/iu/messages.json",localeCode:"iu"}]),this.gamify=!0,this.tutorialMode=!1,this.currentlyPlaying=!1,this.autoPlaySlideshowOfStimuli=!1,this.audiencesController=RangeController.create().initWithContent(this.audiences),this.audiencesController.selection=[],this.audiencesController.addRangeAtPathChangeListener("selection",this,"handleAudienceChange"),this.localesController=RangeController.create().initWithContent([{iso:"en",label:"English"},{iso:"fr",label:"français"},{iso:"iu",label:"ᐃᓄᒃᑎᑐᑦ"}]),this.localesController.selection=[],this.localesController.addRangeAtPathChangeListener("selection",this,"handleLocaleChange")}},draw:{value:function(){this.super();var e=this;window.setTimeout(function(){if(!e.currentlyPlaying){var t=confirm("Do you want to have a tutorial?");t&&(console.log("Showing tutorial mode"),e.toggleTutorialArea())}},3e4)}},enterDocument:{value:function(e){this.super(),e&&this.setupFirstDisplay(),this.experimentDisplayTimeStart=Date.now()}},handlePress:{value:function(e){console.log("The experiment has been pressed: "),"playGame"===e.targetElement.dataset.montageId&&this.run(),"showTutorial"===e.targetElement.dataset.montageId&&this.toggleTutorialArea(),this.autoPlaySlideshowOfStimuli=!1}},prepareForActivationEvents:{value:function(){this._pressComposer.addEventListener("pressStart",this,!1),this._pressComposer.addEventListener("press",this,!1),this._pressComposer.addEventListener("pressCancel",this,!1)}},setupFirstDisplay:{value:function(){this.element.removeEventListener("touchstart",this,!1),this.element.removeEventListener("mousedown",this,!1),this._pressComposer=PressComposer.create(),this._pressComposer.identifier="experiment",this.addComposerForElement(this._pressComposer,this.element),this.showPlayButton()}},showPlayButton:{value:function(){this.templateObjects.playGame.element.hidden=!1,this.templateObjects.showGameCondition.element.hidden=!0,this.templateObjects.showGameDetailsCondition.element.hidden=!0}},toggleTutorialArea:{value:function(){this.showTutorial=!this.showTutorial,this.templateObjects.showGameDetailsCondition.element.hidden=!this.showTutorial,console.log("Show tutorial:"+this.showTutorial)}},run:{value:function(){this.currentlyPlaying=!0,this.templateObjects.showGameCondition.element.hidden=!1,this.templateObjects.playGame.element.hidden=!0,this._currentStimulus=this.templateObjects.currentStimulus,this._currentStimulus.imageAssetsPath=this.experimentalDesign.imageAssetsPath,this._currentStimulus.audioAssetsPath=this.experimentalDesign.audioAssetsPath,this.nextStimulus()}},nextStimulus:{value:function(){this._currentStimulusIndex++,console.log("Showing stimulus "+this._currentStimulusIndex+" of block "+this._currentTestBlockIndex);var e=this._currentTestBlock.trials[this._currentStimulusIndex];if(e){if(e.id=this._currentTestBlock.label+this._currentStimulusIndex,this._currentStimulus.load(e),this.autoPlaySlideshowOfStimuli){var t=this;window.setTimeout(function(){console.log("Slideshow play..."),t.nextStimulus()},5e3)}}else alert("Ready for the real thing?")}},autoPlaySlideshowOfStimuli:{value:null},previousStimulus:{value:function(){this._currentStimulusIndex--,console.log("Showing stimulus "+this._currentStimulusIndex+" of block "+this._currentTestBlockIndex);var e=this._currentTestBlock.trials[this._currentStimulusIndex];e?this._currentStimulus.load(e):alert("At the beginning!")}},pause:{value:function(){}},_targetAudience:{value:null},targetAudience:{get:function(){return this._targetAudience},set:function(e){this._targetAudience!==e&&(this._targetAudience=e,this.needsDraw=!0)}},audiences:{value:[{gameLabel:"Child",experimentLabel:"Participant",key:"participant"},{gameLabel:"Teacher",experimentLabel:"Administrator",key:"experimentAdministrator"},{gameLabel:"Parent",experimentLabel:"Parent",key:"parent"},{gameLabel:"SLP",experimentLabel:"Administrator",key:"experimentAdministratorSpecialist"},{gameLabel:"School Records",experimentLabel:"Report",key:"report"},{gameLabel:"Default",experimentLabel:"Default",key:"default"}]},handleAudienceChange:{value:function(e,t){if(e&&0!=e.length&&e[0]){var i=this.gamify?"gameLabel":"experimentLabel";console.log("Audience changed from: "+(t[0]?t[0][i]:"nothing")+" -> "+(e[0]?e[0][i]:"nothing")),this.targetAudience=e[0].key,console.log(this.description),console.log(this.title)}}},handleLocaleChange:{value:function(e,t){e&&0!=e.length&&e[0]&&console.log("Locale changed from: "+(t[0]?t[0].label:"nothing")+" -> "+(e[0]?e[0].label:"nothing"))}},gamify:{value:null},_description:{value:null},description:{get:function(){var e=this._description||"";if(!this.experimentalDesign||!this.experimentalDesign.description)return e;this.targetAudience&&(e=this.experimentalDesign.description["for_"+this.targetAudience]),e||(e=this.experimentalDesign.description["default"]||"");var t=this.contextualizer.localize(e);return t},set:function(e){this._description!==e&&(this._description=e)}},_title:{value:null},title:{get:function(){var e=this._title||"";if(!this.experimentalDesign||!this.experimentalDesign.title)return e;this.gamify&&(e=this.experimentalDesign.title.gamified_title||""),e||(e=this.experimentalDesign.title["default"]||"");var t=this.contextualizer.localize(e);return t},set:function(e){this._title!==e&&(this._title=e)}},handleAction:{value:function(e){console.log("handleAction has been triggered: ",e)}}});