var Component=require("montage/ui/component").Component,Confirm=require("ui/confirm.reel").Confirm,Response=require("ui/response.reel").Response,PressComposer=require("montage/composer/press-composer").PressComposer,RangeController=require("montage/core/range-controller").RangeController,Promise=require("montage/core/promise").Promise;exports.AbstractStimulus=Component.specialize({constructor:{value:function(){this.super(),window.audioEndListener=function(){var e=this.getAttribute("src");console.log("audiourl is done "+e)}}},rangeController:{value:null},responses:{value:null},pauseAudioWhenConfirmingResponse:{value:null},addResponse:{value:function(e,i){if(!e)throw"Cannot add response without the x y information found in the touch/click responseEvent";var o=Date.now(),t=this.audioElement.duration||0;t?t=1e3*t:console.log("The audio has no duration.. This is strange."),this.pauseAudioWhenConfirmingResponse&&this.pauseAudio();var n=this,s=this.confirmResponseChoiceMessage,a=Promise.defer();if(s){var u={iconSrc:n.ownerComponent.iconSrc,message:s,okLabel:"Yes",cancelLabel:"No"};Confirm.show(u,function(){a.resolve()},function(){a.reject(Error("The x prevented the cancel?"))})}else a.resolve();a.promise.then(function(){n.stopAudio(),n.ownerComponent.nextStimulus()},function(){console.log("Not continuing to next stimulus"),this.pauseAudioWhenConfirmingResponse&&n.playAudio()});var o=Date.now(),l={reactionTimeAudioOffset:o-this.reactionTimeStart-t,reactionTimeAudioOnset:o-this.reactionTimeStart,x:e.x,y:e.y,pageX:e.pageX,pageY:e.pageY,chosenVisualStimulus:i,responseScore:1};this.responses.push(l),console.log("Recorded response",l)}},addNonResponse:{value:function(e){if(!e)throw"Cannot add response without the x y information found in the touch/click responseEvent";var i=Date.now(),o={reactionTimeAudioOffset:i-this.reactionTimeStart,reactionTimeAudioOnset:i-this.reactionTimeStart,x:e.x,y:e.y,pageX:e.pageX,pageY:e.pageY,chosenVisualStimulus:"none",responseScore:-1};this.nonResponses.push(o),console.log("Recorded non-response, the user is confused or not playing the game.",o)}},enterDocument:{value:function(e){this.super(),e&&(this.setupFirstPlay(),this.addOwnPropertyChangeListener("src",this)),this.reactionTimeStart=Date.now(),this.audioElement=document.getElementById("audio")}},handlePress:{value:function(e){console.log("The stimulus has been pressed: "),e&&e.targetElement&&e.targetElement.dataset&&e.targetElement.dataset.montageId&&e.targetElement.classList.contains("Stimulus-record-touch-response")?this.addResponse(e.event,e.targetElement.dataset.montageId):this.addNonResponse(e.event)}},prepareForActivationEvents:{value:function(){this._pressComposer.addEventListener("pressStart",this,!1),this._pressComposer.addEventListener("press",this,!1),this._pressComposer.addEventListener("pressCancel",this,!1)}},setupFirstPlay:{value:function(){this.element.removeEventListener("touchstart",this,!1),this.element.removeEventListener("mousedown",this,!1),this._pressComposer=PressComposer.create(),this._pressComposer.identifier="stimulus",this.addComposerForElement(this._pressComposer,this.element)}},playAudio:{value:function(){this.audioElement.removeEventListener("ended",window.audioEndListener),this.audioElement.addEventListener("ended",window.audioEndListener),this.audioElement.play(),this.audioPlayStarted=Date.now()}},audioElement:{value:null},pauseAudio:{value:function(){this.audioElement.pause(),this.audioElement.currentTime>.05&&(this.audioElement.currentTime=this.audioElement.currentTime-.05)}},stopAudio:{value:function(){this.audioElement.pause(),this.audioElement.currentTime=0}},load:{value:function(e){for(var i in e)e.hasOwnProperty(i)&&(this[i]=e[i]);null===this.responses&&(this.responses=[]),null===this.nonResponses&&(this.nonResponses=[]),this.nonResponses=[],this.rangeController=(new RangeController).initWithContent(this.responses),this.audioElement.src=this.audioFile,this.playAudio()}}});