function main(e){new HttpServer({GET:createServlet(StaticServlet),HEAD:createServlet(StaticServlet)}).start(Number(e[2])||DEFAULT_PORT)}function escapeHtml(e){return(""+e).replace("<","&lt;").replace(">","&gt;").replace('"',"&quot;")}function createServlet(e){var t=new e;return t.handleRequest.bind(t)}function HttpServer(e){this.handlers=e,this.server=http.createServer(this.handleRequest_.bind(this))}function StaticServlet(){}var util=require("util"),http=require("http"),fs=require("fs"),url=require("url"),events=require("events"),DEFAULT_PORT=8e3;HttpServer.prototype.start=function(e){this.port=e,this.server.listen(e),util.puts("Http Server running at http://localhost:"+e+"/")},HttpServer.prototype.parseUrl_=function(e){var t=url.parse(e);return t.pathname=url.resolve("/",t.pathname),url.parse(url.format(t),!0)},HttpServer.prototype.handleRequest_=function(e,t){var i=e.method+" "+e.url;e.headers["user-agent"]&&(i+=" "+e.headers["user-agent"]),util.puts(i),e.url=this.parseUrl_(e.url);var n=this.handlers[e.method];n?n.call(this,e,t):(t.writeHead(501),t.end())},StaticServlet.MimeMap={txt:"text/plain",html:"text/html",css:"text/css",xml:"application/xml",json:"application/json",js:"application/javascript",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",png:"image/png",svg:"image/svg+xml"},StaticServlet.prototype.handleRequest=function(e,t){var i=this,n=("./"+e.url.pathname).replace("//","/").replace(/%(..)/g,function(e,t){return String.fromCharCode(parseInt(t,16))}),o=n.split("/");return"."===o[o.length-1].charAt(0)?i.sendForbidden_(e,t,n):(fs.stat(n,function(o,s){return o?i.sendMissing_(e,t,n):s.isDirectory()?i.sendDirectory_(e,t,n):i.sendFile_(e,t,n)}),void 0)},StaticServlet.prototype.sendError_=function(e,t,i){t.writeHead(500,{"Content-Type":"text/html"}),t.write("<!doctype html>\n"),t.write("<title>Internal Server Error</title>\n"),t.write("<h1>Internal Server Error</h1>"),t.write("<pre>"+escapeHtml(util.inspect(i))+"</pre>"),util.puts("500 Internal Server Error"),util.puts(util.inspect(i))},StaticServlet.prototype.sendMissing_=function(e,t,i){i=i.substring(1),t.writeHead(404,{"Content-Type":"text/html"}),t.write("<!doctype html>\n"),t.write("<title>404 Not Found</title>\n"),t.write("<h1>Not Found</h1>"),t.write("<p>The requested URL "+escapeHtml(i)+" was not found on this server.</p>"),t.end(),util.puts("404 Not Found: "+i)},StaticServlet.prototype.sendForbidden_=function(e,t,i){i=i.substring(1),t.writeHead(403,{"Content-Type":"text/html"}),t.write("<!doctype html>\n"),t.write("<title>403 Forbidden</title>\n"),t.write("<h1>Forbidden</h1>"),t.write("<p>You do not have permission to access "+escapeHtml(i)+" on this server.</p>"),t.end(),util.puts("403 Forbidden: "+i)},StaticServlet.prototype.sendRedirect_=function(e,t,i){t.writeHead(301,{"Content-Type":"text/html",Location:i}),t.write("<!doctype html>\n"),t.write("<title>301 Moved Permanently</title>\n"),t.write("<h1>Moved Permanently</h1>"),t.write('<p>The document has moved <a href="'+i+'">here</a>.</p>'),t.end(),util.puts("301 Moved Permanently: "+i)},StaticServlet.prototype.sendFile_=function(e,t,i){var n=this,o=fs.createReadStream(i);t.writeHead(200,{"Content-Type":StaticServlet.MimeMap[i.split(".").pop()]||"text/plain"}),"HEAD"===e.method?t.end():(o.on("data",t.write.bind(t)),o.on("close",function(){t.end()}),o.on("error",function(i){n.sendError_(e,t,i)}))},StaticServlet.prototype.sendDirectory_=function(e,t,i){var n=this;if(i.match(/[^\/]$/)){e.url.pathname+="/";var o=url.format(url.parse(url.format(e.url)));return n.sendRedirect_(e,t,o)}fs.readdir(i,function(o,s){if(o)return n.sendError_(e,t,error);if(!s.length)return n.writeDirectoryIndex_(e,t,i,[]);var a=s.length;s.forEach(function(o,r){fs.stat(i+"/"+o,function(l,u){return l?n.sendError_(e,t,l):(u.isDirectory()&&(s[r]=o+"/"),--a?void 0:n.writeDirectoryIndex_(e,t,i,s))})})})},StaticServlet.prototype.writeDirectoryIndex_=function(e,t,i,n){return i=i.substring(1),t.writeHead(200,{"Content-Type":"text/html"}),"HEAD"===e.method?(t.end(),void 0):(t.write("<!doctype html>\n"),t.write("<title>"+escapeHtml(i)+"</title>\n"),t.write("<style>\n"),t.write("  ol { list-style-type: none; font-size: 1.2em; }\n"),t.write("</style>\n"),t.write("<h1>Directory: "+escapeHtml(i)+"</h1>"),t.write("<ol>"),n.forEach(function(e){"."!==e.charAt(0)&&t.write('<li><a href="'+escapeHtml(e)+'">'+escapeHtml(e)+"</a></li>")}),t.write("</ol>"),t.end(),void 0)},main(process.argv);