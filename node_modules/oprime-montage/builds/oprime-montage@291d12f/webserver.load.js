montageDefine("291d12f","webserver",{dependencies:["util","http","fs","url","events"],factory:function(e){function t(e){new o({GET:n(s),HEAD:n(s)}).start(Number(e[2])||c)}function i(e){return(""+e).replace("<","&lt;").replace(">","&gt;").replace('"',"&quot;")}function n(e){var t=new e;return t.handleRequest.bind(t)}function o(e){this.handlers=e,this.server=r.createServer(this.handleRequest_.bind(this))}function s(){}var a=e("util"),r=e("http"),l=e("fs"),u=e("url");e("events");var c=8e3;o.prototype.start=function(e){this.port=e,this.server.listen(e),a.puts("Http Server running at http://localhost:"+e+"/")},o.prototype.parseUrl_=function(e){var t=u.parse(e);return t.pathname=u.resolve("/",t.pathname),u.parse(u.format(t),!0)},o.prototype.handleRequest_=function(e,t){var i=e.method+" "+e.url;e.headers["user-agent"]&&(i+=" "+e.headers["user-agent"]),a.puts(i),e.url=this.parseUrl_(e.url);var n=this.handlers[e.method];n?n.call(this,e,t):(t.writeHead(501),t.end())},s.MimeMap={txt:"text/plain",html:"text/html",css:"text/css",xml:"application/xml",json:"application/json",js:"application/javascript",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",png:"image/png",svg:"image/svg+xml"},s.prototype.handleRequest=function(e,t){var i=this,n=("./"+e.url.pathname).replace("//","/").replace(/%(..)/g,function(e,t){return String.fromCharCode(parseInt(t,16))}),o=n.split("/");return"."===o[o.length-1].charAt(0)?i.sendForbidden_(e,t,n):(l.stat(n,function(o,s){return o?i.sendMissing_(e,t,n):s.isDirectory()?i.sendDirectory_(e,t,n):i.sendFile_(e,t,n)}),void 0)},s.prototype.sendError_=function(e,t,n){t.writeHead(500,{"Content-Type":"text/html"}),t.write("<!doctype html>\n"),t.write("<title>Internal Server Error</title>\n"),t.write("<h1>Internal Server Error</h1>"),t.write("<pre>"+i(a.inspect(n))+"</pre>"),a.puts("500 Internal Server Error"),a.puts(a.inspect(n))},s.prototype.sendMissing_=function(e,t,n){n=n.substring(1),t.writeHead(404,{"Content-Type":"text/html"}),t.write("<!doctype html>\n"),t.write("<title>404 Not Found</title>\n"),t.write("<h1>Not Found</h1>"),t.write("<p>The requested URL "+i(n)+" was not found on this server.</p>"),t.end(),a.puts("404 Not Found: "+n)},s.prototype.sendForbidden_=function(e,t,n){n=n.substring(1),t.writeHead(403,{"Content-Type":"text/html"}),t.write("<!doctype html>\n"),t.write("<title>403 Forbidden</title>\n"),t.write("<h1>Forbidden</h1>"),t.write("<p>You do not have permission to access "+i(n)+" on this server.</p>"),t.end(),a.puts("403 Forbidden: "+n)},s.prototype.sendRedirect_=function(e,t,i){t.writeHead(301,{"Content-Type":"text/html",Location:i}),t.write("<!doctype html>\n"),t.write("<title>301 Moved Permanently</title>\n"),t.write("<h1>Moved Permanently</h1>"),t.write('<p>The document has moved <a href="'+i+'">here</a>.</p>'),t.end(),a.puts("301 Moved Permanently: "+i)},s.prototype.sendFile_=function(e,t,i){var n=this,o=l.createReadStream(i);t.writeHead(200,{"Content-Type":s.MimeMap[i.split(".").pop()]||"text/plain"}),"HEAD"===e.method?t.end():(o.on("data",t.write.bind(t)),o.on("close",function(){t.end()}),o.on("error",function(i){n.sendError_(e,t,i)}))},s.prototype.sendDirectory_=function(e,t,i){var n=this;if(i.match(/[^\/]$/)){e.url.pathname+="/";var o=u.format(u.parse(u.format(e.url)));return n.sendRedirect_(e,t,o)}l.readdir(i,function(o,s){if(o)return n.sendError_(e,t,error);if(!s.length)return n.writeDirectoryIndex_(e,t,i,[]);var a=s.length;s.forEach(function(o,r){l.stat(i+"/"+o,function(l,u){return l?n.sendError_(e,t,l):(u.isDirectory()&&(s[r]=o+"/"),--a?void 0:n.writeDirectoryIndex_(e,t,i,s))})})})},s.prototype.writeDirectoryIndex_=function(e,t,n,o){return n=n.substring(1),t.writeHead(200,{"Content-Type":"text/html"}),"HEAD"===e.method?(t.end(),void 0):(t.write("<!doctype html>\n"),t.write("<title>"+i(n)+"</title>\n"),t.write("<style>\n"),t.write("  ol { list-style-type: none; font-size: 1.2em; }\n"),t.write("</style>\n"),t.write("<h1>Directory: "+i(n)+"</h1>"),t.write("<ol>"),o.forEach(function(e){"."!==e.charAt(0)&&t.write('<li><a href="'+i(e)+'">'+i(e)+"</a></li>")}),t.write("</ol>"),t.end(),void 0)},t(process.argv)}});